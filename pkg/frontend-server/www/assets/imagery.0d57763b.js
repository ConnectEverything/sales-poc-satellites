import{o as l,c,e,B as z,L as U,M as R,N as I,O as X,v as C,d as G,z as Y,r as $,s as J,I as Q,j as ee,w as E,S as te,g as d,F as A,E as N,t as u,l as L,f as k,i as D}from"./vendor.81649689.js";import{a as ae}from"./index.76fb6db5.js";import{n as se,b as ne,e as oe,f as T,d as V}from"./nats.66aa6ce2.js";import{c as j}from"./index.75cc0599.js";const ie={viewBox:"0 0 24 24",width:"1.2em",height:"1.2em"},le=e("path",{fill:"currentColor",d:"M21 7L9 19l-5.5-5.5l1.41-1.41L9 16.17L19.59 5.59L21 7Z"},null,-1),re=[le];function de(a,n){return l(),c("svg",ie,re)}const ce={name:"mdi-check",render:de};const ue={props:{before:{type:String,required:!0},after:{type:String,required:!0},full:{type:Boolean,default:!1},padding:{type:Object,default(){return{left:0,right:0}},required:!1},hideAfter:{type:Boolean,default:!1,required:!1}},data(){return{width:null,height:null,pageX:null,posX:null,isDragging:!1,allowNextFrame:!0,unwatch:null}},computed:{dimensions(){return{width:`${this.width}px`,height:this.full?`${this.height}px`:"auto"}}},methods:{onResize(){this.width=this.$el.clientWidth,this.height=this.$el.clientHeight,this.setInitialPosX(this.padding.left+this.padding.right)},onMouseDown(){this.isDragging=!0},onMouseUp(a){a.preventDefault(),this.isDragging=!1},onMouseMove(a,n=this.isDragging){n&&this.allowNextFrame&&(this.allowNextFrame=!1,this.pageX=a.pageX||a.targetTouches[0].pageX||a.originalEvent.targetTouches[0].pageX,window.requestAnimationFrame(this.updatePos))},updatePos(){let a=this.pageX-this.$el.getBoundingClientRect().left;a<this.padding.left?a=this.padding.left:a>this.width-this.padding.right&&(a=this.width-this.padding.right),this.posX=a,this.allowNextFrame=!0},setInitialPosX(a){if(a>=this.width){console.error("Sum of paddings is wider then parent element!");return}this.posX=(this.width+this.padding.left-this.padding.right)/2}},created(){window.addEventListener("mouseup",this.onMouseUp),window.addEventListener("resize",this.onResize)},mounted(){this.onResize(),this.unwatch=this.$watch(()=>this.padding.left+this.padding.right,a=>this.setInitialPosX(a))},beforeDestroy(){this.unwatch(),window.removeEventListener("mouseup",this.onMouseUp),window.removeEventListener("resize",this.onResize)}},he=["src","alt"],me=["src","alt"],_e={class:"image-compare-handle-icon left"},fe={class:"image-compare-handle-icon right"};function pe(a,n,p,M,x,h){return l(),c("figure",{class:C(["image-compare",{full:p.full}]),onMousemove:n[1]||(n[1]=X((...g)=>h.onMouseMove&&h.onMouseMove(...g),["prevent"])),onTouchstart:n[2]||(n[2]=g=>h.onMouseMove(g,!0)),onTouchmove:n[3]||(n[3]=g=>h.onMouseMove(g,!0)),onClick:n[4]||(n[4]=g=>h.onMouseMove(g,!0))},[z(e("div",{class:"image-compare-wrapper",style:R({width:x.posX+"px"})},[e("img",{src:p.after,alt:p.after,style:R(h.dimensions)},null,12,he)],4),[[U,!p.hideAfter]]),e("img",{src:p.before,alt:p.before,style:R(h.dimensions)},null,12,me),z(e("div",{class:"image-compare-handle",style:R({left:x.posX+"px"}),onMousedown:n[0]||(n[0]=X((...g)=>h.onMouseDown&&h.onMouseDown(...g),["prevent"]))},[e("span",_e,[I(a.$slots,"icon-left",{},void 0,!0)]),e("span",fe,[I(a.$slots,"icon-right",{},void 0,!0)])],36),[[U,!p.hideAfter]])],34)}const ge=ae(ue,[["render",pe],["__scopeId","data-v-b30873cd"]]),ve={viewBox:"0 0 24 24",width:"1.2em",height:"1.2em"},be=e("path",{fill:"currentColor",d:"M6.4 18L5 16.6L9.575 12L5 7.4L6.4 6l6 6l-6 6Zm6.6 0l-1.4-1.4l4.575-4.6L11.6 7.4L13 6l6 6l-6 6Z"},null,-1),we=[be];function ye(a,n){return l(),c("svg",ve,we)}const xe={name:"material-symbols-keyboard-double-arrow-right",render:ye},Fe={viewBox:"0 0 24 24",width:"1.2em",height:"1.2em"},Ce=e("path",{fill:"currentColor",d:"m11 18l-6-6l6-6l1.4 1.4L7.825 12l4.575 4.6L11 18Zm6.6 0l-6-6l6-6L19 7.4L14.425 12L19 16.6L17.6 18Z"},null,-1),Re=[Ce];function Le(a,n){return l(),c("svg",Fe,Re)}const ke={name:"material-symbols-keyboard-double-arrow-left",render:Le},Me={viewBox:"0 0 24 24",width:"1.2em",height:"1.2em"},Be=e("path",{fill:"currentColor",d:"M21.5 14.5L16 20l-5.5-5.5l1.41-1.41L15 16.17V10.5C15 8 13 6 10.5 6H4V4h6.5a6.5 6.5 0 0 1 6.5 6.5v5.67l3.09-3.09l1.41 1.42Z"},null,-1),Pe=[Be];function $e(a,n){return l(),c("svg",Me,Pe)}const De={name:"mdi-arrow-down-right",render:$e},Se={viewBox:"0 0 24 24",width:"1.2em",height:"1.2em"},ze=e("path",{fill:"currentColor",d:"M20 4v2h-6.5C11 6 9 8 9 10.5v5.67l3.09-3.08l1.41 1.41L8 20l-5.5-5.5l1.41-1.42L7 16.17V10.5A6.5 6.5 0 0 1 13.5 4H20Z"},null,-1),Ue=[ze];function Ie(a,n){return l(),c("svg",Se,Ue)}const Xe={name:"mdi-arrow-down-left",render:Ie};function Ee(a,n=1024){a=Math.abs(a);const p=Math.floor(Math.log(a)/Math.log(n)),M=["Bytes","KB","MB","GB","TB","PB","EB","ZB","YB"];var x=a/Math.pow(n,p)*1,h=M[p];return h==="Bytes"&&(x===0||x===1)&&(h=h.slice(0,-1)),h?x.toFixed(2)+" "+h:a.toString()}const Ae=e("div",null,"Waiting for NATS server",-1),Ne={class:"h-full"},Te={key:0,class:"grid w-full h-full place-items-center"},Ve={key:1,class:"flex flex-col gap-4"},je=e("div",{class:"text-2xl text-center uppercase text-bold"}," Imagery from timelapses ",-1),Ze={class:"flex flex-col items-center gap-4"},He={class:"card-body"},qe={class:"flex flex-wrap justify-between"},Oe={class:"uppercase card-title"},We={class:"opacity-50 card-compact"},Ke={class:"opacity-50 card-compact"},Ge={key:0,class:"grid w-full place-items-center"},Ye={class:"items-start w-full steps"},Je=e("div",{class:"font-bold"},"Pull from feed",-1),Qe={key:0},et=e("div",{class:"font-bold"},"Convert to Images",-1),tt=e("div",{class:"font-bold"},"Upload High Resolution",-1),at={key:1},st=e("div",{class:"font-bold"},"Convert to Web",-1),nt={key:1},ot={key:1,class:"flex flex-col items-center gap-4"},it=e("div",{class:"divider"},"Compare",-1),lt={class:"flex flex-col items-center gap-2"},rt={class:"flex flex-wrap items-end gap-4"},dt=["onClick"],ct=["src"],ut=["onClick"],ht={class:"flex items-center gap-2"},mt=["onClick"],_t=["onClick"],ft=["onClick"],pt={key:0,class:"w-full rounded-6xl"},gt={class:"table table-compact"},vt=e("caption",null," Image differencing service ",-1),bt=e("thead",null,[e("tr",null,[e("th",{class:""},"Type"),e("th",null,"Score")])],-1),wt=e("th",null,"Average",-1),yt=e("th",null,"Difference",-1),xt=e("th",null,"Perception",-1),Ft=e("div",{class:"divider"},null,-1),Ct={class:"justify-end card-actions"},Rt=["onClick"],$t=G({__name:"imagery",async setup(a){let n,p;const[M,x,h]=([n,p]=Y(()=>Promise.all([se(),ne("satellite-metadata"),oe("web-friendly-images")])),n=await n,p(),n),g=async(s,r,o)=>{const m=`${s.id}_${r.toString().padStart(5,"0")}_${o}`,f=await h.get(m);if(!f?.data)return;const _=await f.data.getReader(),y=[];for(;;){const{done:i,value:b}=await _.read();if(i)break;b&&b.length&&y.push(b)}const B=new Blob(y,{type:"image/jpg"});return URL.createObjectURL(B)},w=$([]),v=$([]),Z=J(()=>w.value.map((s,r)=>{const o=v.value[r].thumbnail;if(!o)return;const m=5,f=[];for(let _=o-m;_<=o+m;_++)_<1||_>s.metadata.webFriendly.lastFrameProcessed||f.push(_);return f})),H=j(async()=>{const s=v.value;if(!s.length)return[];const r=s.map(async(o,m)=>{if(!o||!h)return;const f=w.value[m];return await g(f.metadata,o.thumbnail,"thumbnail")});return await Promise.all(r)},[]),q=s=>{const r=v.value[s];r.left=r.thumbnail;const o=w.value[s].metadata.id;S(o,r.left,r.right)},O=s=>{const r=v.value[s];r.right=r.thumbnail;const o=w.value[s].metadata.id;S(o,r.left,r.right)},F=$([]),S=async(s,r,o)=>{const m=w.value.findIndex(B=>B.metadata.id===s);if(m===-1)return;F.value[m]={averageDistance:0,differenceDistance:0,perceptionDistance:0};const f=T({videoFeedID:s,startFrame:r,endFrame:o}),_=await M.request("satellite-imagery-diff",f,{timeout:10*1e3}),y=V(_.data);y.error&&console.error(y.error),F.value[m]=y.success},P=j(async()=>{const s=v.value;if(!s.length)return[];const r=s.map(async(o,m)=>{if(!o||!h)return{leftURL:"",rightURL:""};const{metadata:f}=w.value[m],[_,y]=await Promise.all([g(f,o.left,"full"),g(f,o.right,"full")]);return{leftURL:_,rightURL:y}});return await Promise.all(r)},[]);Q(async()=>{for await(const s of await x.watch()){const{value:r,revision:o}=s,m=V(r),f=m.id.toString();let _=w.value.findIndex(y=>y.metadata.id.toString()===f);_===-1?(w.value.push({metadata:m,revision:o}),v.value.push({thumbnail:1,left:1,right:1}),F.value.push({averageDistance:0,differenceDistance:0,perceptionDistance:0}),_=w.value.length-1):w.value[_]={metadata:m,revision:o}}});async function W(s){s.metadata.shouldBeProcessed=!0,await x.update(s.metadata.id.toString(),T(s.metadata),s.revision)}async function K(){await M.publish("satellites.metadata.pull")}return(s,r)=>{const o=Xe,m=De,f=ke,_=xe,y=ge,B=ce;return l(),ee(te,null,{fallback:E(()=>[Ae]),default:E(()=>[e("div",Ne,[d(w).length?(l(),c("div",Ve,[je,e("div",Ze,[(l(!0),c(A,null,N(d(w),(t,i)=>(l(),c("div",{class:"w-full max-w-6xl shadow-lg card bg-base-100",key:t.metadata.id.toString()},[e("div",He,[e("div",qe,[e("div",null,[e("div",Oe,u(t.metadata.initialSourceURL.split("/").slice(-1)[0].split(".")[0].replaceAll("-"," ")),1),e("div",We," ID: "+u(t.metadata.id),1),e("div",Ke," SOURCE: "+u(t.metadata.initialSourceURL),1)])]),t.metadata.shouldBeProcessed&&(!t.metadata.webFriendly.frameCount||t.metadata.webFriendly.lastFrameProcessed!==t.metadata.webFriendly.frameCount)?(l(),c("div",Ge,[e("ul",Ye,[e("li",{"data-content":"\u{1F4E1}",class:C(["step",{"step-primary":t.metadata.pullFromFeed.bytes}])},[Je,e("div",null,u(t.metadata.pullFromFeed.wasCached?"Cached":"Downloaded"),1),t.metadata.pullFromFeed.bytes?(l(),c("div",Qe,u(d(Ee)(t.metadata.pullFromFeed.bytes)),1)):L("",!0)],2),e("li",{"data-content":"\u{1F3A5}",class:C(["step",{"step-primary":t.metadata.hiRez.conversionProgress==="done"}])},[et,e("div",null,u(t.metadata.hiRez.orginalResolutionWidth)+"x"+u(t.metadata.hiRez.orginalResolutionHeight),1),t.metadata.hiRez.conversionProgress.endsWith("%")?(l(),c("div",{key:0,class:"radial-progress",style:R(`--value: ${t.metadata.hiRez.conversionProgress.replaceAll("%","")};`)},u(t.metadata.hiRez.conversionProgress),5)):L("",!0)],2),e("li",{"data-content":"\u2B06\uFE0F",class:C(["step",{"step-primary":t.metadata.hiRez.frameCount&&t.metadata.hiRez.lastFrameUploaded===t.metadata.hiRez.frameCount}])},[tt,t.metadata.hiRez.lastFrameUploaded!==t.metadata.hiRez.frameCount?(l(),c("div",{key:0,class:"radial-progress",style:R(`--value: ${Math.round(100*t.metadata.hiRez.lastFrameUploaded/t.metadata.hiRez.frameCount)};`)},u(Math.round(100*t.metadata.hiRez.lastFrameUploaded/t.metadata.hiRez.frameCount))+"% ",5)):(l(),c("div",at,u(t.metadata.hiRez.frameCount)+" frames ",1))],2),e("li",{"data-content":"\u{1F5BC}\uFE0F",class:C(["step",{"step-primary":t.metadata.webFriendly.frameCount&&t.metadata.webFriendly.lastFrameProcessed===t.metadata.webFriendly.frameCount}])},[st,t.metadata.webFriendly.lastFrameProcessed!==t.metadata.webFriendly.frameCount?(l(),c("div",{key:0,class:"radial-progress",style:R(`--value: ${Math.round(100*t.metadata.webFriendly.lastFrameProcessed/t.metadata.webFriendly.frameCount)};`)},u(Math.round(100*t.metadata.webFriendly.lastFrameProcessed/t.metadata.webFriendly.frameCount))+"% ",5)):(l(),c("div",nt,[e("div",null," Full: "+u(t.metadata.webFriendly.width)+"x"+u(t.metadata.webFriendly.height),1),e("div",null," Thumbnails: "+u(t.metadata.webFriendly.thumbnailWidth)+"x"+u(t.metadata.webFriendly.thumbnailHeight),1)]))],2)])])):L("",!0),t.metadata.shouldBeProcessed&&t.metadata.webFriendly.frameCount?(l(),c("div",ot,[it,e("div",lt,[e("div",rt,[e("button",{class:"btn btn-primary btn-xl",onClick:b=>q(i)},[k(o),D(" Set Left "+u(d(v)[i].left),1)],8,dt),e("img",{class:"object-contain shadow-2xl select-none rounded-xl ring-2 ring-primary",src:d(H)[i]},null,8,ct),e("button",{class:"btn btn-primary btn-xl",onClick:b=>O(i)},[k(m),D(" Set Right "+u(d(v)[i].right),1)],8,ut)]),e("div",ht,[e("button",{class:"btn btn-ghost btn-sm",onClick:b=>d(v)[i].thumbnail=1},[k(f)],8,mt),(l(!0),c(A,null,N(d(Z)[i],b=>(l(),c("button",{class:C(["btn",{"btn-primary":b===d(v)[i].thumbnail,"btn-ghost":b!==d(v)[i].thumbnail}]),onClick:Lt=>d(v)[i].thumbnail=b},u(b),11,_t))),256)),e("button",{class:"btn btn-ghost btn-sm",onClick:b=>d(v)[i].thumbnail=t.metadata.webFriendly.lastFrameProcessed},[k(_)],8,ft)])]),d(P)[i]?.leftURL&&d(P)[i]?.rightURL?(l(),c("div",pt,[k(y,{full:!1,after:d(P)[i].leftURL,before:d(P)[i].rightURL},null,8,["after","before"])])):L("",!0),e("div",null,[e("table",gt,[vt,bt,e("tbody",null,[e("tr",null,[wt,e("td",{class:C(["text-xl font-bold",{"text-error":d(F)[i].averageDistance>5}])},u(d(F)[i].averageDistance||"-"),3)]),e("tr",null,[yt,e("td",{class:C(["text-xl font-bold",{"text-error":d(F)[i].differenceDistance>5}])},u(d(F)[i].differenceDistance||"-"),3)]),e("tr",null,[xt,e("td",{class:C(["text-xl font-bold",{"text-error":d(F)[i].perceptionDistance>5}])},u(d(F)[i].perceptionDistance||"-"),3)])])])]),Ft])):L("",!0),e("div",Ct,[t.metadata.shouldBeProcessed?L("",!0):(l(),c("button",{key:0,class:"btn btn-success btn-block btn-xl",onClick:b=>W(t)},[k(B),D(" Start Process ")],8,Rt))])])]))),128))])])):(l(),c("div",Te,[e("button",{class:"btn btn-primary btn-xl",onClick:K}," Load metadata from source ")]))])]),_:1})}}});export{$t as default};
